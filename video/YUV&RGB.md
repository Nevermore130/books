### YUV & RGB ###

#### RGB ####

图像的**每一个像素都有 R、G、B 三个值。**RGB 是我们平常遇到最多的一种图像颜色空间，比如**摄像头采集的原始图像就是 RGB 图像**，且显示器显示的图像也是 RGB 图像。

比如对于一张 8bit 位深的 RGB 图，每个值占用一个字节

虽然 RGB 比较简单，同时在图像处理的时候也经常会用到。但是在视频领域，我们更多地是使用 YUV 颜色空间来表示图像的。这是因为 R、G、B 三个颜色是有相关性的，所以不太方便做图像压缩编码。



#### YUV ####

**YUV 图像将亮度信息 Y 与色彩信息 U、V 分离开来**。Y 表示亮度，是图像的总体轮廓，称之为 Y 分量。U、V 表示色度，主要描绘图像的色彩等信息，分别称为 U 分量和 V 分量

考虑到兼容老的黑白电视机，如果使用 RGB 表示图像，那么黑白电视机就没办法播放。这是因为 R、G、B 三个通道都是彩色的，而 Y、U、V 就可以。因为黑白电视机可以使用 Y 分量，Y 分量就是黑白图像，而且包含了图像的总体轮廓信息，只是没有色彩信息而已。



**YUV** 主要分为 YUV 4:4:4、YUV 4:2:2、YUV 4:2:0 这几种常用的类型。其中**最常用的又是 YUV 4:2:0**。这三种类型的 YUV 主要的区别就是 U、V 分量像素点的个数和采集方式。



**YUV 4:4:4 就是每一个 Y 就对应一个 U 和一个 V**

每一个 Y 对应一个 U、一个 V，所以存储的方式也非常简单。例如，4 x 2 像素的 YUV 4:4:4 存储图如下图所示：

<img src="https://static001.geekbang.org/resource/image/04/53/0428a59eb7702e4feb9bafd80ac83553.jpeg?wh=1920x1080" style="zoom: 33%;" />

YUV 4:4:4 和 RGB 图像存储之后的大小是一样的。如果是 8bit 图像，就是每一个像素点需要占用 3 个字节。(**算占用的字节可以基于有多少Y分量来算，比如8个Y, 按照YUV 4: 4: 4 存储就是 8 * 3 = 24个字节)**



**YUV 4:2:2**

每左右两个像素的 Y 共用一个 U 和一个 V。存储方式主要有以下４种类型。

* YU16（或者称为 I422、YUV422P）,4 x 2 像素的 YU16 存储图如下图所示：

![](https://static001.geekbang.org/resource/image/9f/45/9fb26028da7201cdbc7dd7f8dd83b145.jpeg?wh=1912x756)

4 x 2 像素的 YUV 4:2:2 只需要 16 个字节，而 RGB 图像则需要 24 个字节。也就是说，如果是 8bit 图像，那么 RGB 每一个像素需要 3 个字节，而 YUV 4:2:2 只需要 2 个字节



**YUV 4:2:0**

通常视频压缩都是 YUV 4:2:0 格式的。它是每上、下、左、右 4 个像素点共用一个 U 和一个 V。

* YU12（I420、YUV420P）

4 x 4 像素的 YU12 存储图如下图所示：

![](https://static001.geekbang.org/resource/image/76/16/766ce511056bf5dd3399198398b80016.jpeg?wh=1920x1080)

* NV21（YUV420SP）

  与 NV12 不同，这种格式是先存储完 Y，之后 V、U 连续交错存储。例如，4 x 4 像素的 NV21 存储图如下图所示：

  ![](https://static001.geekbang.org/resource/image/9e/bd/9ed80ef848c52123fb41413abfa26ebd.jpeg?wh=1920x1080)

**4 x 4 像素的 YUV 4:2:0 只需要 24 个字节相比 RGB 图像需要 48 个字节，存储的大小少了一半。**也就是说，如果是 8bit 图像，RGB 每一个像素需要 3 个字节。而 YUV 4:2:0 只需要 1.5 个字节。



#### RGB 和 YUV 之间的转换 ####

一般来说，采集到的原始图像、给显示器渲染的最终图像都是 RGB 图像，但是视频编码一般用的是 YUV 图像

转换之前，先了解 Color Range 这个东西。对于一个 8bit 的 RGB 图像，它的每一个 R、G、B 分量的取值按理说就是 0~255 的。但是真的是这样的吗？其实不是的。这里就涉及到 Color Range 这个概念。**Color Range 分为两种，一种是 Full Range，一种是 Limited Range。Full Range 的 R、G、B 取值范围都是 0～255。而 Limited Range 的 R、G、B 取值范围是 16～235。**

BT709 和 BT601 定义了一个 RGB 和 YUV 互转的标准规范。只有我们都按照标准来做事，那么不同厂家生产出来的产品才能对接上。**BT601 是标清的标准，而 BT709 是高清的标准。**



两种标准分别在 Full Range 和 Limited Range 下的 RGB 和 YUV 之间的转换公式：

![](https://static001.geekbang.org/resource/image/19/72/19da3510c564b590f92cf969be01d872.jpeg?wh=1920x1080)

如果是系统采集出来给到用户的图像就是 YUV 的话，你也需要获取这个 YUV 的存储格式、转换标准和 Color Range。这样才能保证正确地处理 YUV 和 RGB 之间的转换。



在处理 YUV 图像的存储和读取的时候，也是有 Stride 这个概念的。事实上，YUV 出问题的情况更多。在这里举一个例子，**比如说一张 1283x720 的图像，一个 Y 分量存储按 16 字节对齐的话应该是每行占用 1296 个字节，所以每读取一行像素的 Y 应该是 1296 个字节**，具体如下图所示。千万不要认为是 1283 个字节，不然就会出现“花屏”。这里一定要注意。

![](https://static001.geekbang.org/resource/image/80/57/808b8310bb6dfbabfc3d6fbc2ce88057.jpeg?wh=1920x1080)





